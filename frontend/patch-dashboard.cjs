const fs = require("fs");
const path = require("path");

const filePath = path.join(__dirname, "src/pages/HotelOwnerDashboard.jsx");
const content = fs.readFileSync(filePath, "utf8");
const lines = content.split("\n");

console.log("Total lines before patch:", lines.length);

// Use fixed line numbers from our analysis (0-indexed)
const brokenStart = 1884; // line AFTER the pending bar closing </div>
const brokenEnd = 1888; // the premature </main> line (inclusive)

console.log("Patching from line", brokenStart + 1, "to line", brokenEnd + 1);

// We build the replacement as an array of strings so template literals stay literal.
const R = [
  "                                      </div>",
  "                                    </div>",
  '                                    <div className="flex gap-4 mt-2 text-xs text-gray-500">',
  '                                      <span className="flex items-center gap-1">',
  '                                        <span className="w-3 h-3 rounded bg-green-500 inline-block"></span>Paid',
  "                                      </span>",
  '                                      <span className="flex items-center gap-1">',
  '                                        <span className="w-3 h-3 rounded bg-amber-400 inline-block"></span>Pending',
  "                                      </span>",
  "                                    </div>",
  "                                  </>",
  "                                ) : (",
  '                                  <p className="text-sm text-gray-400 py-4 text-center">No revenue data yet</p>',
  "                                )}",
  "                              </div>",
  "                            </div>",
  "                          </div>",
  "",
  "                          {/* ─── MONTHLY REVENUE REPORT ──────────────── */}",
  '                          <div className="bg-white rounded-xl shadow p-6 mb-6">',
  '                            <div className="flex items-center justify-between mb-5">',
  "                              <div>",
  '                                <h3 className="text-base font-semibold text-gray-900">Monthly Revenue Report</h3>',
  '                                <p className="text-xs text-gray-500 mt-0.5">Revenue and bookings — last 6 months</p>',
  "                              </div>",
  "                            </div>",
  "                            {analyticsData.monthlyRevenue.length === 0 ? (",
  '                              <div className="text-center py-10 text-gray-400 text-sm">No monthly data available</div>',
  "                            ) : (",
  "                              <>",
  "                                {/* CSS Bar Chart */}",
  "                                <div className=\"flex items-end gap-2 mb-1\" style={{ height: '176px' }}>",
  "                                  {(() => {",
  "                                    const maxRev = Math.max(...analyticsData.monthlyRevenue.map((m) => m.revenue), 1);",
  "                                    return analyticsData.monthlyRevenue.map((m, i) => (",
  '                                      <div key={i} className="flex-1 flex flex-col items-center gap-1">',
  '                                        <span className="text-xs text-gray-500 font-medium truncate w-full text-center">',
  "                                          {m.revenue >= 1000 ? (m.revenue / 1000).toFixed(1) + 'k' : '$' + m.revenue}",
  "                                        </span>",
  "                                        <div",
  '                                          className="w-full bg-indigo-500 hover:bg-indigo-600 rounded-t-md transition-colors cursor-default"',
  "                                          style={{ height: Math.max((m.revenue / maxRev) * 140, 4) + 'px' }}",
  "                                          title={'Revenue: $' + m.revenue.toLocaleString() + ' | Bookings: ' + m.bookings}",
  "                                        ></div>",
  '                                        <span className="text-xs text-gray-500">{m.label}</span>',
  "                                      </div>",
  "                                    ));",
  "                                  })()}",
  "                                </div>",
  "                                {/* Summary Table */}",
  '                                <div className="overflow-x-auto mt-4 border border-gray-100 rounded-lg">',
  '                                  <table className="w-full text-sm">',
  "                                    <thead>",
  '                                      <tr className="bg-gray-50 border-b border-gray-200">',
  '                                        <th className="text-left px-4 py-2.5 text-xs font-semibold text-gray-500 uppercase tracking-wide">Month</th>',
  '                                        <th className="text-right px-4 py-2.5 text-xs font-semibold text-gray-500 uppercase tracking-wide">Revenue</th>',
  '                                        <th className="text-right px-4 py-2.5 text-xs font-semibold text-gray-500 uppercase tracking-wide">Bookings</th>',
  '                                        <th className="text-right px-4 py-2.5 text-xs font-semibold text-gray-500 uppercase tracking-wide">Avg / Booking</th>',
  '                                        <th className="text-right px-4 py-2.5 text-xs font-semibold text-gray-500 uppercase tracking-wide">Trend</th>',
  "                                      </tr>",
  "                                    </thead>",
  "                                    <tbody>",
  "                                      {analyticsData.monthlyRevenue.map((m, i) => {",
  "                                        const prev = analyticsData.monthlyRevenue[i - 1];",
  "                                        const trend = prev",
  "                                          ? prev.revenue === 0",
  "                                            ? m.revenue > 0 ? 100 : 0",
  "                                            : Math.round(((m.revenue - prev.revenue) / prev.revenue) * 100)",
  "                                          : null;",
  "                                        return (",
  '                                          <tr key={i} className="border-b border-gray-50 hover:bg-gray-50">',
  '                                            <td className="px-4 py-2.5 font-medium text-gray-700">{m.label}</td>',
  '                                            <td className="px-4 py-2.5 text-right font-semibold text-gray-900">${m.revenue.toLocaleString()}</td>',
  '                                            <td className="px-4 py-2.5 text-right text-gray-600">{m.bookings}</td>',
  '                                            <td className="px-4 py-2.5 text-right text-gray-500">',
  "                                              {m.bookings > 0 ? '$' + Math.round(m.revenue / m.bookings).toLocaleString() : '—'}",
  "                                            </td>",
  '                                            <td className="px-4 py-2.5 text-right">',
  "                                              {trend === null ? (",
  '                                                <span className="text-gray-300 text-xs">—</span>',
  "                                              ) : trend > 0 ? (",
  '                                                <span className="text-emerald-600 text-xs font-semibold">▲ {trend}%</span>',
  "                                              ) : trend < 0 ? (",
  '                                                <span className="text-red-500 text-xs font-semibold">▼ {Math.abs(trend)}%</span>',
  "                                              ) : (",
  '                                                <span className="text-gray-400 text-xs">— 0%</span>',
  "                                              )}",
  "                                            </td>",
  "                                          </tr>",
  "                                        );",
  "                                      })}",
  "                                    </tbody>",
  "                                    <tfoot>",
  '                                      <tr className="bg-indigo-50 border-t border-indigo-100">',
  '                                        <td className="px-4 py-2.5 font-semibold text-indigo-800">Total (6 months)</td>',
  '                                        <td className="px-4 py-2.5 text-right font-bold text-indigo-800">',
  "                                          ${analyticsData.monthlyRevenue.reduce((s, m) => s + m.revenue, 0).toLocaleString()}",
  "                                        </td>",
  '                                        <td className="px-4 py-2.5 text-right font-bold text-indigo-800">',
  "                                          {analyticsData.monthlyRevenue.reduce((s, m) => s + m.bookings, 0)}",
  "                                        </td>",
  '                                        <td className="px-4 py-2.5 text-right font-semibold text-indigo-700">',
  "                                          {(() => {",
  "                                            const tb = analyticsData.monthlyRevenue.reduce((s, m) => s + m.bookings, 0);",
  "                                            const tr = analyticsData.monthlyRevenue.reduce((s, m) => s + m.revenue, 0);",
  "                                            return tb > 0 ? '$' + Math.round(tr / tb).toLocaleString() : '—';",
  "                                          })()}",
  "                                        </td>",
  "                                        <td></td>",
  "                                      </tr>",
  "                                    </tfoot>",
  "                                  </table>",
  "                                </div>",
  "                              </>",
  "                            )}",
  "                          </div>",
  "",
  "                          {/* ─── BOOKING TRENDS + BRANCH REVENUE ──────── */}",
  '                          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">',
  "",
  "                            {/* Booking Trends */}",
  '                            <div className="bg-white rounded-xl shadow p-6">',
  '                              <div className="mb-5">',
  '                                <h3 className="text-base font-semibold text-gray-900">Booking Trends</h3>',
  '                                <p className="text-xs text-gray-500 mt-0.5">Status breakdown — last 6 months</p>',
  "                              </div>",
  "                              {analyticsData.bookingTrends.length === 0 ? (",
  '                                <div className="text-center py-10 text-gray-400 text-sm">No booking trend data</div>',
  "                              ) : (",
  "                                <>",
  "                                  {/* Grouped bar chart */}",
  "                                  <div className=\"flex items-end gap-3 mb-3\" style={{ height: '120px' }}>",
  "                                    {(() => {",
  "                                      const maxB = Math.max(...analyticsData.bookingTrends.map((t) => t.bookings), 1);",
  "                                      return analyticsData.bookingTrends.map((t, i) => (",
  '                                        <div key={i} className="flex-1 flex flex-col items-center gap-1">',
  "                                          <div className=\"w-full flex items-end gap-0.5 justify-center\" style={{ height: '96px' }}>",
  "                                            <div",
  '                                              className="flex-1 bg-blue-400 rounded-t hover:bg-blue-500 transition-colors"',
  "                                              style={{ height: Math.max((t.checkedIn / maxB) * 100, 2) + '%' }}",
  "                                              title={'Checked In: ' + t.checkedIn}",
  "                                            ></div>",
  "                                            <div",
  '                                              className="flex-1 bg-emerald-400 rounded-t hover:bg-emerald-500 transition-colors"',
  "                                              style={{ height: Math.max((t.checkedOut / maxB) * 100, 2) + '%' }}",
  "                                              title={'Checked Out: ' + t.checkedOut}",
  "                                            ></div>",
  "                                            <div",
  '                                              className="flex-1 bg-red-400 rounded-t hover:bg-red-500 transition-colors"',
  "                                              style={{ height: Math.max((t.cancelled / maxB) * 100, 2) + '%' }}",
  "                                              title={'Cancelled: ' + t.cancelled}",
  "                                            ></div>",
  "                                          </div>",
  '                                          <span className="text-xs text-gray-500">{t.month}</span>',
  "                                        </div>",
  "                                      ));",
  "                                    })()}",
  "                                  </div>",
  "                                  {/* Legend */}",
  '                                  <div className="flex flex-wrap gap-4 text-xs text-gray-500 mb-4">',
  '                                    <span className="flex items-center gap-1.5">',
  '                                      <span className="w-3 h-3 rounded bg-blue-400 inline-block"></span>Checked In',
  "                                    </span>",
  '                                    <span className="flex items-center gap-1.5">',
  '                                      <span className="w-3 h-3 rounded bg-emerald-400 inline-block"></span>Checked Out',
  "                                    </span>",
  '                                    <span className="flex items-center gap-1.5">',
  '                                      <span className="w-3 h-3 rounded bg-red-400 inline-block"></span>Cancelled',
  "                                    </span>",
  "                                  </div>",
  "                                  {/* Table */}",
  '                                  <div className="overflow-x-auto border border-gray-100 rounded-lg">',
  '                                    <table className="w-full text-xs">',
  "                                      <thead>",
  '                                        <tr className="bg-gray-50 border-b border-gray-200">',
  '                                          <th className="text-left px-3 py-2 text-gray-500 uppercase font-semibold tracking-wide">Month</th>',
  '                                          <th className="text-right px-3 py-2 text-gray-500 uppercase font-semibold tracking-wide">Total</th>',
  '                                          <th className="text-right px-3 py-2 text-blue-500 uppercase font-semibold tracking-wide">In</th>',
  '                                          <th className="text-right px-3 py-2 text-emerald-500 uppercase font-semibold tracking-wide">Out</th>',
  '                                          <th className="text-right px-3 py-2 text-red-500 uppercase font-semibold tracking-wide">Cancel</th>',
  "                                        </tr>",
  "                                      </thead>",
  "                                      <tbody>",
  "                                        {analyticsData.bookingTrends.map((t, i) => (",
  '                                          <tr key={i} className="border-b border-gray-50 hover:bg-gray-50">',
  '                                            <td className="px-3 py-2 font-medium text-gray-700">{t.month}</td>',
  '                                            <td className="px-3 py-2 text-right font-semibold text-gray-900">{t.bookings}</td>',
  '                                            <td className="px-3 py-2 text-right text-blue-600">{t.checkedIn}</td>',
  '                                            <td className="px-3 py-2 text-right text-emerald-600">{t.checkedOut}</td>',
  '                                            <td className="px-3 py-2 text-right text-red-600">{t.cancelled}</td>',
  "                                          </tr>",
  "                                        ))}",
  "                                      </tbody>",
  "                                    </table>",
  "                                  </div>",
  "                                </>",
  "                              )}",
  "                            </div>",
  "",
  "                            {/* Branch-wise Revenue */}",
  '                            <div className="bg-white rounded-xl shadow p-6">',
  '                              <div className="mb-5">',
  '                                <h3 className="text-base font-semibold text-gray-900">Branch-wise Revenue</h3>',
  '                                <p className="text-xs text-gray-500 mt-0.5">Revenue contribution per branch</p>',
  "                              </div>",
  "                              {analyticsData.branchWiseRevenue.length === 0 ? (",
  '                                <div className="text-center py-10 text-gray-400 text-sm">No branch revenue data available</div>',
  "                              ) : (",
  '                                <div className="space-y-5">',
  "                                  {(() => {",
  "                                    const maxRev = Math.max(...analyticsData.branchWiseRevenue.map((b) => b.revenue), 1);",
  "                                    const totalRev = analyticsData.branchWiseRevenue.reduce((s, b) => s + b.revenue, 0);",
  "                                    const colors = ['bg-indigo-500', 'bg-emerald-500', 'bg-amber-500', 'bg-rose-500', 'bg-violet-500'];",
  "                                    return analyticsData.branchWiseRevenue.map((branch, i) => {",
  "                                      const barPct = Math.max(Math.round((branch.revenue / maxRev) * 100), 2);",
  "                                      const sharePct = totalRev > 0 ? Math.round((branch.revenue / totalRev) * 100) : 0;",
  "                                      return (",
  "                                        <div key={branch.branchId || i}>",
  '                                          <div className="flex justify-between items-start mb-1.5">',
  '                                            <div className="min-w-0 flex-1 mr-3">',
  '                                              <p className="text-sm font-medium text-gray-800 truncate">{branch.branchName}</p>',
  '                                              <p className="text-xs text-gray-400">{branch.hotelName} &middot; {sharePct}% of total</p>',
  "                                            </div>",
  '                                            <span className="text-sm font-bold text-gray-900 whitespace-nowrap">${branch.revenue.toLocaleString()}</span>',
  "                                          </div>",
  '                                          <div className="w-full bg-gray-100 rounded-full h-3">',
  "                                            <div",
  "                                              className={colors[i % colors.length] + ' h-3 rounded-full transition-all duration-500'}",
  "                                              style={{ width: barPct + '%' }}",
  "                                            ></div>",
  "                                          </div>",
  "                                        </div>",
  "                                      );",
  "                                    });",
  "                                  })()}",
  '                                  <div className="pt-4 border-t border-gray-100">',
  '                                    <div className="flex justify-between items-center mb-2">',
  '                                      <span className="text-sm font-semibold text-gray-600">Total Portfolio Revenue</span>',
  '                                      <span className="text-lg font-bold text-gray-900">',
  "                                        ${analyticsData.branchWiseRevenue.reduce((s, b) => s + b.revenue, 0).toLocaleString()}",
  "                                      </span>",
  "                                    </div>",
  "                                    {/* Stacked share bar */}",
  '                                    <div className="flex h-2 rounded-full overflow-hidden bg-gray-100">',
  "                                      {analyticsData.branchWiseRevenue.map((branch, i) => {",
  "                                        const tv = analyticsData.branchWiseRevenue.reduce((s, b) => s + b.revenue, 0);",
  "                                        const pct = tv > 0 ? (branch.revenue / tv) * 100 : 0;",
  "                                        const cols = ['bg-indigo-500', 'bg-emerald-500', 'bg-amber-500', 'bg-rose-500', 'bg-violet-500'];",
  "                                        return (",
  "                                          <div",
  "                                            key={i}",
  "                                            className={cols[i % cols.length]}",
  "                                            style={{ width: pct + '%' }}",
  "                                            title={branch.branchName + ': $' + branch.revenue.toLocaleString()}",
  "                                          ></div>",
  "                                        );",
  "                                      })}",
  "                                    </div>",
  "                                  </div>",
  "                                </div>",
  "                              )}",
  "                            </div>",
  "                          </div>",
  "                        </>",
  "                      )}",
  "                    </div>",
  "                  )}",
  "                </div>",
  "              </div>",
  "            </main>",
];

const newLines = [
  ...lines.slice(0, brokenStart),
  ...R,
  ...lines.slice(brokenEnd + 1),
];

fs.writeFileSync(filePath, newLines.join("\n"), "utf8");
console.log("Patch applied successfully!");
console.log("New total lines:", newLines.length);
